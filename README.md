以下は、最新のご要望（Obsidian風の“同一ページ内ライブプレビュー”、メニュートグル＋メモ一覧、設定画面で保存ディレクトリ/フォント/カラースキーム設定）を **既存要件に完全統合**した、Rust実装前提の仕様書です。あわせて、要件を確実に満たすための技術選定・開発ロードマップも再設計しています。

---

## 1. 目的とコンセプト

* **ショートカット一発で即表示し、書いて閉じたら必ず保存**される、超高速Markdownメモアプリ。
* UIは Obsidian の Live Preview に近く、**入力しているその場で同じページ内に整形が反映**される（左右分割はしない）。
* **メモの管理は最小限**：保存ディレクトリ直下のメモ一覧（ファイル）を見て開ける。編集と保存が中心。

---

## 2. 必須要件（統合版）

### 2.1 クロスプラットフォーム

* Windows / macOS / Linux で同一機能・同一挙動。

### 2.2 起動・終了（超重要）

* グローバルホットキー（デフォルト：`Ctrl + Shift + Space`）で **高速起動（実態は“表示トグル”）**。
* もう一度ホットキーを押す、もしくはウィンドウを閉じると **自動保存**。
* 自動保存は「保存完了保証」：保存処理が成功するまで “閉じたことにならない” 挙動（失敗時はエラー表示し編集画面維持）。

### 2.3 UIテーマ

* デフォルト：**Tokyoナイトカラースキーム**（ダーク、低輝度、コントラスト過多を避けた配色）。
* 設定でカラースキーム変更可（最低限：Tokyo Night / Light の2種、将来拡張可能）。

### 2.4 Markdownメモ仕様

* メモは Markdown ファイル。
* 作成時に **メタデータ（作成日時・uid）** を付与。
* 保存時のファイル名は **`{uid}.md`**（uidがタイトル＝永続ID）。

### 2.5 プレビュー（更新要件）

* 左右分割はしない。
* **同一ページ内ライブプレビュー**：Markdownの一部（見出し、太字、リンク、コード等）が、入力中に視覚的に整形される。
* 内部的には “Markdownソース” が単一の真実（ファイルに保存されるのはMarkdownテキスト）。

### 2.6 メモ一覧・設定（更新要件）

* アプリを開いた直後は **Markdown入力ページ（編集画面）**。
* 左上に **メニュートグル（ハンバーガー）**。

  * 押すと **保存ディレクトリ直下の全メモ一覧** を表示。
  * 一覧最下部に **設定アイコン**。
* 設定で以下を変更可能：

  * 保存ディレクトリ
  * フォント（ファミリ/サイズ/行間）
  * カラースキーム

### 2.7 ウィンドウサイズ/位置

* ウィンドウのサイズと位置を記憶し、次回は同じジオメトリで開く。
* 画面外に出ている場合は、自動で可視領域に補正。

---

## 3. 画面・操作仕様（UX）

### 3.1 編集画面（ホーム）

* 起動（表示）時に最前面・フォーカスを編集領域へ。
* 編集領域は「ライブプレビュー」表示（Obsidian Live Preview相当）。
* 最小ボタン：

  * 左上：メニュートグル
* キー操作（初期案）：

  * `Ctrl+Shift+Space`：保存して非表示（常駐）
  * ウィンドウ×：保存して非表示（常駐）
  * `Ctrl+S`：手動保存（即時保存、画面は開いたまま）

> “閉じる＝終了” ではなく、**閉じる＝保存して隠れる（常駐に戻る）** を基本とします。完全終了はトレイ/メニューから。

### 3.2 メニュー（メモ一覧）

* 表示対象：保存ディレクトリ直下の `*.md`。
* 表示順：デフォルトは **最終更新日時（desc）**。
* 表示要素（1行）：

  * 表示名（後述）
  * 更新日時（相対/絶対どちらでも可、最小は省略可）
* メモ選択で編集画面に戻り、そのメモを開く。
* メニュー最下部：

  * 設定アイコン（歯車）

#### 表示名ルール（ファイル名はuidでも可読性確保）

* ファイル名は `{uid}.md` を維持。
* 一覧の表示名は次の優先順で生成（保存は変えない）：

  1. Front Matter の `title` があればそれ
  2. Markdown先頭の最初の見出し（`# ...`）
  3. それも無ければ uid

※要件上「保存時はuidをタイトルにする」は **ファイル名**の意味として厳格に満たしつつ、UI表示名は利便性のため派生表示を許可する設計です（ファイル名は不変）。

### 3.3 設定画面

* 設定項目：

  * 保存ディレクトリ（フォルダピッカー）
  * フォント（ファミリ選択、サイズ、行間）
  * カラースキーム（Tokyo Night / Light …）
  * （推奨）ホットキー変更：衝突時の回避に必要になるため将来項目として枠だけ確保
* 設定は即時反映（テーマ・フォント）。

---

## 4. データ仕様（ファイル・メタデータ・保存）

### 4.1 Markdownファイル形式（YAML Front Matter）

ファイル先頭に YAML Front Matter を必須付与：

```markdown
---
uid: "01J1Z9P6V9WQ7H9QXGQ2K5J1ZC"
created_at: "2026-01-13T06:12:34+09:00"
updated_at: "2026-01-13T06:15:10+09:00"
---

本文…
```

* uid：ULID推奨（生成が高速、衝突しにくい、時系列ソート性）
* updated_at：保存のたび更新

### 4.2 ファイル名

* 新規作成：`{uid}.md`
* 既存編集：同一ファイルを上書き（uid不変）

### 4.3 保存方式（堅牢性）

* **アトミック保存**：

  1. `{uid}.md.tmp` に書き込み
  2. flush/fsync
  3. rename で `{uid}.md` を置換
* 保存失敗時：

  * 画面は閉じない
  * エラーを表示し、リトライ導線を提供

### 4.4 自動保存のトリガ

* 必須：

  * ホットキー再押下（非表示化前）
  * ウィンドウ閉じる操作
* 推奨（体験向上）：

  * 入力停止後 1–2秒で autosave（失敗しても編集継続）

---

## 5. ウィンドウジオメトリ永続化

### 5.1 記録対象

* `x, y, width, height`
* `is_maximized`
* 可能なら `monitor_id` / `scale_factor`

### 5.2 記録タイミング

* move/resize をデバウンス（300–500ms）して保存
* 非表示化・終了直前にも最終保存

### 5.3 補正ルール

* 次回表示時、保存ジオメトリが可視領域外なら、最寄りの可視領域へ移動しサイズをクランプ。

---

## 6. 技術選定（要件適合で再評価）

### 6.1 推奨：Tauri v2（Rustコア + WebView UI）

この仕様で最も重要なのは「ライブプレビュー編集体験」「クロスOS」「グローバルホットキー」「常駐」「ウィンドウ制御」です。これらを総合すると Tauri が最も現実的です。

* **Rust（バックエンド）**：

  * ホットキー登録、常駐、ウィンドウ表示/非表示、保存、uid生成、設定永続化、ファイル一覧、ファイル監視
* **フロントエンド（WebView）**：

  * ライブプレビュー編集UI（Obsidian風）
  * メニュー（ドロワー）と設定画面

#### ライブプレビュー実装方針（重要）

* **“単一のMarkdownテキスト”** を保持しつつ、エディタ上に装飾（デコレーション）を重ねて見た目をリッチにする方式を採用。
* 実装候補（概念）：

  * 高機能テキストエディタ基盤（例：インクリメンタル構文解析＋デコレーション）
  * Markdown構文のインクリメンタル解析（入力に追従）
* 最小実装範囲：

  * 見出し、太字/斜体、インラインコード、コードブロック、リンク、箇条書き、引用

> 左右分割プレビューより難易度は上がりますが、“ライブプレビュー”はWeb UI側の成熟したエディタ基盤を使うのが最短です。純Rust UI（egui等）で同等体験を出すのは工数が増えます。

### 6.2 代替（非推奨寄り）：egui + winit

* 可能だが、ライブプレビュー編集体験の再現が難しく、IMEや編集快適性で追加工数が出やすい。
* 本件は UI 体験が要件の中心に移ったため、採用優先度は下がります。

---

## 7. 内部アーキテクチャ（Rust側）

### 7.1 Rustモジュール

* `core/note`

  * uid生成（ULID）
  * front matter parse/generate（YAML）
* `core/storage`

  * 保存ディレクトリ解決
  * アトミック保存
* `core/index`

  * ディレクトリ直下をスキャンしてメモ一覧生成
  * 表示名生成（title/heading/uid）
* `core/settings`

  * 保存先、フォント、テーマ、ウィンドウジオメトリ
* `platform/hotkey`

  * OS別のホットキー登録（失敗時エラー、将来は変更可能に）
* `platform/window`

  * show/hide、focus、ジオメトリ restore/save、画面外補正
* `platform/fswatch`（推奨）

  * 外部更新を検知して一覧を更新（最小要件ではポーリングでも可）

### 7.2 状態機械（保存保証のため）

* `Hidden`：常駐、ウィンドウ非表示
* `Visible`：編集可能
* `Saving`：保存中（UI入力一時抑止可）
* 重要遷移：

  * Hotkey（Hidden→Visible）
  * Hotkey/Close（Visible→Saving→Hidden）
  * SaveFail（Saving→Visible + エラー表示）

---

## 8. 開発ロードマップ（統合要件に合わせて再構成）

### Phase 0：常駐・トグル表示・CI

* Tauri雛形、3OSビルド
* トレイ常駐（または同等の常駐メカニズム）
* ホットキーで show/hide トグル
* 最前面＋フォーカス

**完了条件**：3OSでホットキー表示/非表示が成立

### Phase 1：ウィンドウジオメトリ永続化（先に固める）

* 初回の自動配置・自動サイズ
* 位置/サイズ/最大化状態の保存と復元
* 画面外補正

**完了条件**：調整した位置/サイズで必ず再表示される

### Phase 2：UI骨格（編集画面 + メニュー + 設定）

* 編集画面（プレーンな入力欄でも可）
* 左上メニュートグル → ドロワー表示
* 保存ディレクトリ直下のメモ一覧表示
* 設定画面（保存先/フォント/テーマ）

**完了条件**：メモ一覧で開ける、設定が反映される

### Phase 3：ライブプレビュー編集（Obsidian風）

* インクリメンタル解析＋デコレーションで同一ページ内整形
* パフォーマンス対策（入力遅延回避）
* 最小対応Markdownセットを完成

**完了条件**：左右分割なしで“その場整形”が体感よく動く

### Phase 4：保存仕様（uid/front matter/アトミック）＋自動保存保証

* 新規作成時 uid 生成、front matter 挿入
* `{uid}.md` のアトミック保存
* 閉じる/ホットキー再押下で保存完了保証
* 失敗時のエラー表示とリトライ

**完了条件**：“閉じたら必ず保存”が壊れない

### Phase 5（推奨）：堅牢性・快適性

* autosave（アイドル時）
* 外部変更監視（一覧更新）
* 検索（一覧内フィルタ）※最小でも簡易検索があると運用が楽

---

## 9. 受入基準（この仕様の合否判定）

* ホットキーで即表示、再押下/閉じるで必ず保存して隠れる（3OS）
* ファイル名は必ず uid、front matter に uid/日時が入る
* 編集は同一ページ内ライブプレビュー（左右分割なし）
* メニューで保存ディレクトリ直下のメモが列挙され、選択して開ける
* 設定で保存先/フォント/テーマが変えられ、反映される
* ウィンドウ位置/サイズが記憶され、次回同じ状態で開く（画面外補正あり）

---

必要なら次に、上記仕様をさらに実装に落とすために、以下をそのまま作れます（追加質問なしで進められます）。

* 設定ファイルの具体フォーマット（TOML/JSON）とキー定義
* メモ一覧生成の高速化（先頭N行だけ読む、キャッシュ）
* ライブプレビューで最小対応するMarkdown要素の「厳密な範囲定義」
* 保存時のfront matter更新ルール（updated_at、title抽出など）
